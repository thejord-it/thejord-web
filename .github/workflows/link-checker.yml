name: Link Checker

on:
  # Esegui ogni giorno alle 6:00 UTC
  schedule:
    - cron: '0 6 * * *'
  # Esegui manualmente
  workflow_dispatch:
  # Esegui dopo ogni deploy su master
  workflow_run:
    workflows: ["Build and Deploy thejord-web"]
    types:
      - completed
    branches:
      - master

jobs:
  check-links:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run link checker
        id: check
        run: node scripts/check-links.js
        env:
          SITE_URL: https://thejord.it
        continue-on-error: true

      - name: Create issue if links are broken
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”— Broken links detected';
            const body = `
            ## Broken Links Detected

            The scheduled link checker found broken links on the website.

            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Date:** ${new Date().toISOString()}

            Please check the workflow logs for details and fix the broken links.
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['broken-links', 'automated']
              });
            }

      - name: Close issue if links are fixed
        if: steps.check.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });

            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                body: issue.body + '\n\n---\nâœ… All links are now working. Closed automatically.'
              });
            }
